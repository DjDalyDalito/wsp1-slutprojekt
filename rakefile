require_relative 'config'
require 'rake'
require 'sqlite3'

desc "Start Sinatra app with rerun for auto-reload"
task :dev do
  sh 'bundle exec rerun --ignore "*.{erb,js,css}" --force-polling "rackup --host 0.0.0.0"'
end

desc "Fill the database with initial data from the seeder file"
task :seed do
  require_relative './db/seeder'
  puts "âœ… Database done seeding!"
end

def tables_ok?
  return false unless File.exist?(DB_PATH)
  db = SQLite3::Database.new(DB_PATH)
  rows = db.execute("SELECT name FROM sqlite_master WHERE type='table' AND name IN ('messages','orders')")
  names = rows.flatten
  names.include?('messages') && names.include?('orders')
ensure
  db&.close
end

desc "Default task: seeds db if missing tables, then start dev server"
task default: [] do
  if !tables_ok?
    puts "ðŸ“¦ Missing tables - running seed task..."
    Rake::Task[:seed].invoke
  else
    puts "ðŸš€ Database OK - starting app..."
  end

  Rake::Task[:dev].invoke
end
